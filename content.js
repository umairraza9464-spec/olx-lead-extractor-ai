let isExtracting=false;chrome.storage.sync.get(['autoExtract'],(data)=>{if(data.autoExtract!==false){setTimeout(extractData,3000)}});chrome.runtime.onMessage.addListener((request,sender,sendResponse)=>{if(request.action==='extract'){extractData().then(result=>sendResponse(result));return true}});async function extractData(){if(isExtracting)return{success:false,message:'Already extracting'};isExtracting=true;try{const mobile=extractMobile();if(!mobile){isExtracting=false;return{success:false,message:'No mobile found'}}const isDuplicate=await checkDuplicate(mobile);if(isDuplicate){isExtracting=false;return{success:false,message:`Already extracted: ${mobile}`}}const data=await extractAllData(mobile);await sendToBackgroundForProcessing(data);await markExtracted(mobile);await updateStats();isExtracting=false;return{success:true,message:`Extracted: ${mobile}`}}catch(error){isExtracting=false;return{success:false,message:'Error: '+error.message}}}function extractMobile(){const phoneLink=document.querySelector('a[href^="tel:"]');if(phoneLink){const match=phoneLink.href.match(/(\d{10})/);if(match)return match[1]}const selectors=['[class*="phone"]','[class*="mobile"]','[class*="contact"]','button[class*="call"]','span[class*="seller"]'];for(const selector of selectors){const elements=document.querySelectorAll(selector);for(const el of elements){const text=el.textContent||'';const match=text.match(/[6-9]\d{9}/);if(match)return match[0]}}return null}async function extractAllData(mobile){const data={date:new Date().toLocaleDateString('en-IN'),name:'',mobile:mobile,regNo:'',carModel:'',variant:'',year:'',km:'',address:'',followUp:'',source:'OLX',context:'',license:'',remark:''};const title=document.querySelector('h1,[data-aut-id="itemTitle"]');if(title)data.carModel=title.textContent.trim();const specs=document.querySelectorAll('[class*="spec"],[class*="detail"],li');specs.forEach(spec=>{const text=spec.textContent.toLowerCase();if(text.includes('year')||text.includes('model year')){const yearMatch=text.match(/\d{4}/);if(yearMatch)data.year=yearMatch[0]}if(text.includes('km')||text.includes('kilometer')){const kmMatch=text.match(/([\d,]+)\s*km/i);if(kmMatch)data.km=kmMatch[1].replace(/,/g,'')}if(text.includes('variant')){data.variant=spec.textContent.trim()}});const location=document.querySelector('[class*="location"],[class*="address"]');if(location)data.address=location.textContent.trim();const name=document.querySelector('[class*="seller"] span,[class*="username"]');if(name)data.name=name.textContent.trim();const desc=document.querySelector('[data-aut-id="itemDescriptionContent"]');if(desc)data.context=desc.textContent.trim().substring(0,200);data.regNo=await extractRegNoWithLlama();return data}async function extractRegNoWithLlama(){try{const images=document.querySelectorAll('img');const imageUrls=[];for(const img of images){const src=img.src||img.dataset.src;if(src&&!src.includes('logo')&&!src.includes('icon')){imageUrls.push(src);if(imageUrls.length>=5)break}}if(imageUrls.length===0)return '';const config=await chrome.storage.sync.get(['groqApiKey']);if(!config.groqApiKey)return '';const response=await fetch('https://api.groq.com/openai/v1/chat/completions',{method:'POST',headers:{'Authorization':`Bearer ${config.groqApiKey}`,'Content-Type':'application/json'},body:JSON.stringify({model:'llama-3.3-70b-versatile',messages:[{role:'user',content:`Extract only the vehicle registration number from this OLX car listing. Images: ${imageUrls.join(', ')}. Return ONLY the registration number in format: DL01AB1234 or return NONE if not found.`}],max_tokens:50})});if(!response.ok)return '';const result=await response.json();const regNo=result.choices[0]?.message?.content?.trim()||'';return regNo==='NONE'?'':regNo}catch(error){console.error('Llama AI error:',error);return ''}}async function sendToBackgroundForProcessing(data){return new Promise((resolve)=>{chrome.runtime.sendMessage({action:'sendToSheets',data:data},(response)=>{resolve(response)})})}async function checkDuplicate(mobile){return new Promise((resolve)=>{chrome.storage.local.get(['extractedNumbers'],(result)=>{const extracted=result.extractedNumbers||[];resolve(extracted.includes(mobile))})})}async function markExtracted(mobile){return new Promise((resolve)=>{chrome.storage.local.get(['extractedNumbers'],(result)=>{const extracted=result.extractedNumbers||[];extracted.push(mobile);chrome.storage.local.set({extractedNumbers:extracted},()=>resolve())})})}async function updateStats(){return new Promise((resolve)=>{chrome.storage.local.get(['stats'],(result)=>{const stats=result.stats||{total:0,today:0,lastDate:''};const today=new Date().toLocaleDateString('en-IN');if(stats.lastDate!==today){stats.today=1;stats.lastDate=today}else{stats.today++}stats.total++;chrome.storage.local.set({stats:stats},()=>resolve())})})}
